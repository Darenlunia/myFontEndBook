# HTTP代理

#### 1. HTTP代理作用

* `负载均衡`

  客户端发给代理服务器，服务器用算法判断发给哪个源服务器进行处理比较好。让各台服务器的负载尽量平均。例如LRU（最近最少使用）算法等。

* `保障安全`

  对上下行数据进行过滤、对非法IP限流、监控源服务器集群并及时剔除等。

* `缓存代理`

  内容缓存到代理服务器，客户端可以直接从代理服务器获得，不用再到源服务器那里。

#### 2. HTTP代理在HTTP请求中相关头部字段（了解）

* `Via`：proxy\_server1, proxy\_server2 标明代理的身份
* `X-forwarded-for` ：记录请求方的IP，一直在变化，但是HTTPS加密通信协议中，不允许修改原始报文，此时可以用代理协议修改（即，在HTTP请求行上面再加一行文字PROXY T CP4 0.0.0.1 0.0.0.2 1111 2222）（PROXY + TCP4/TCP6 + 请求方地址 + 接收方地址 + 请求端口 + 接收端口）
* `X-Real-IP` ：记录真实客户端的IP

#### 3.HTTP代理缓存

**目的**：分享源服务器的压力。

让代理服务器接管一部分服务器端的HTTP缓存。客户端缓存过期后就到代理缓存中获取。代理缓存过期了再请求源服务器。这样流量巨大的时候可以明显降低源服务器的压力。

**源服务器发送的响应头**的相应属性控制：

* 响应头的Cache-Control字段使用private or public控制是否允许代理服务器缓存
* 响应头的must-revalidate要求客户端缓存过期去源服务器取；proxy-revalidate表示代理服务器缓存过期后到源服务器获取（revalidate 使重新生效）
* s-maxage 限定缓存在代理服务器中可以放多久。
* 举个例子：Cache-Control: public, max-age=1000, s-maxage=2000。这个响应说明服务器是允许代理服务器缓存的，客户端缓存过期了到代理中拿，并且在客户端的缓存时间为 1000 秒，在代理服务器中的缓存时间为 2000 s。

**客户端发送的请求头**的相应字段控制：

* max-stale和min-fresh 时间宽容度
* only-if-cached 客户端只接受代理缓存，不接受源服务器响应。如果代理缓存无效，直接返回504.

